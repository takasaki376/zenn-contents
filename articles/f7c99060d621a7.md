---
title: "Deep Learningè³‡æ ¼è©¦é¨“ æ·±å±¤å­¦ç¿’ ç•³ã¿è¾¼ã¿ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Eè³‡æ ¼"]
published: true
---

# ã¯ã˜ã‚ã«

æ—¥æœ¬ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°å”ä¼šã® Deep Learning è³‡æ ¼è©¦é¨“ï¼ˆE è³‡æ ¼ï¼‰ã®å—é¨“ã«å‘ã‘ã¦ã€èª¿ã¹ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã¦ã„ãã¾ã™ã€‚

# ç•³ã¿è¾¼ã¿å±¤

- å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã„ã‚¿ã‚¹ã‚¯ã‚’è§£ããŸã‚ã«æœ‰ç”¨ãªç‰¹å¾´ã‚’æŠ½å‡ºã™ã‚‹ã€‚
- ï¼’æ¬¡å…ƒã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿$I$ã¨ï¼’æ¬¡å…ƒã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼$K$ãŒã‚ã‚‹å ´åˆã®ç•³ã¿è¾¼ã¿(Goodfellow et al. 2018)

$$
  (I \times K)(i , k) = \sum_m \sum_n I(i + m , j + n) K(m,n)
$$

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

:::details ã‚³ãƒ¼ãƒ‰å®Ÿè£…

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹ Deep Learning](https://www.oreilly.co.jp/books/9784873117584/)ã‹ã‚‰å¼•ç”¨

```python:python
class Convolution:
    def __init__(self, W, b, stride=1, pad=0):
        self.W = W
        self.b = b
        # ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰
        self.stride = stride
        # ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        self.pad = pad

        # ä¸­é–“ãƒ‡ãƒ¼ã‚¿ï¼ˆbackwardæ™‚ã«ä½¿ç”¨ï¼‰
        self.x = None
        self.col = None
        self.col_W = None

        # é‡ã¿ãƒ»ãƒã‚¤ã‚¢ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹¾é…
        self.dW = None
        self.db = None

    def forward(self, x):
        FN, C, FH, FW = self.W.shape
        N, C, H, W = x.shape

        # å‡ºåŠ›ã®é«˜ã•ï¼ˆç«¯æ•°åˆ‡ã‚Šæ¨ã¦ï¼‰
        out_h = 1 + int((H + 2*self.pad - FH) / self.stride)
        # å‡ºåŠ›ã®å¹…ï¼ˆç«¯æ•°åˆ‡ã‚Šæ¨ã¦ï¼‰
        out_w = 1 + int((W + 2*self.pad - FW) / self.stride)

        # ç•³ã¿è¾¼ã¿æ¼”ç®—ã‚’åŠ¹ç‡ã‚ˆãè¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€å…¥åŠ›xã‚’è¡Œåˆ—colã«å¤‰æ›ã™ã‚‹
        col = im2col(x, FH, FW, self.stride, self.pad)

        # ãƒ•ã‚£ãƒ«ã‚¿ã‚’ï¼’æ¬¡å…ƒé…åˆ—ã«å¤‰æ›ã™ã‚‹
        col_W = self.W.reshape(FN, -1).T

        # è¡Œåˆ—ã®ç©ã‚’è¨ˆç®—ã—ã€ãƒã‚¤ãƒ‘ã‚¹ã‚’è¶³ã™
        out = np.dot(col, col_W) + self.b

        # ç”»åƒå½¢å¼ã«æˆ»ã—ã¦ã€ãƒãƒ£ãƒ³ãƒãƒ«ã®è»¸ã‚’ï¼’ç•ªç›®ã«ç§»å‹•ã•ã›ã‚‹
        out = out.reshape(N, out_h, out_w, -1).transpose(0, 3, 1, 2)

        self.x = x
        self.col = col
        self.col_W = col_W

        return out

    def backward(self, dout):
        FN, C, FH, FW = self.W.shape
        dout = dout.transpose(0,2,3,1).reshape(-1, FN)

        self.db = np.sum(dout, axis=0)
        self.dW = np.dot(self.col.T, dout)
        self.dW = self.dW.transpose(1, 0).reshape(FN, C, FH, FW)

        dcol = np.dot(dout, self.col_W.T)
        dx = col2im(dcol, self.x.shape, FH, FW, self.stride, self.pad)

        return dx
```

:::

# ãƒ—ãƒ¼ãƒªãƒ³ã‚°å±¤

- ã‚ã‚‹ç¯„å›²ã”ã¨ã«æœ€å¤§å€¤ã‚„å¹³å‡å€¤ã‚’å–ã‚‹ã“ã¨ã§ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å¾®å°ãªä½ç½®å¤‰åŒ–ã«å¯¾ã—ã¦ã»ã¼ä¸å¤‰ãªè¡¨ç¾ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã¯ã€ç¸¦ãƒ»æ¨ªæ–¹å‘ã®ç©ºé–“ã‚’å°ã•ãã™ã‚‹æ¼”ç®—ã§ã‚ã‚‹ã€‚ãƒ—ãƒ¼ãƒªãƒ³ã‚°å±¤ã«ã¯ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚‹ã€‚

## å­¦ç¿’ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„

- ãƒ—ãƒ¼ãƒªãƒ³ã‚°å±¤ã¯ã€ç•³ã¿è¾¼ã¿å±¤ã¨é•ã£ã¦å­¦ç¿’ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒãŸãªã„ã€‚ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã¯ã€å¯¾è±¡é ˜åŸŸã‹ã‚‰æœ€å¤§å€¤ã‚’å¾—ã‚‹ï¼ˆã‚‚ã—ãã¯å¹³å‡ã‚’å–ã‚‹ï¼‰ã ã‘ã®å‡¦ç†ãªã®ã§ã€å­¦ç¿’ã™ã¹ããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ãªã„ã€‚

## ãƒãƒ£ãƒ³ãƒãƒ«æ•°ã¯å¤‰åŒ–ã—ãªã„

- ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã®æ¼”ç®—ã«ã‚ˆã£ã¦ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ£ãƒ³ãƒãƒ«æ•°ã¯å¤‰åŒ–ã—ãªã„ã€‚

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

:::details ã‚³ãƒ¼ãƒ‰å®Ÿè£…

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹ Deep Learning](https://www.oreilly.co.jp/books/9784873117584/)ã‹ã‚‰å¼•ç”¨

```python:python
class Pooling:
    def __init__(self, pool_h, pool_w, stride=2, pad=0):
        self.pool_h = pool_h
        self.pool_w = pool_w
        self.stride = stride
        self.pad = pad

        self.x = None
        self.arg_max = None

    def forward(self, x):
        N, C, H, W = x.shape
        # å‡ºåŠ›ã®é«˜ã•ï¼ˆç«¯æ•°åˆ‡ã‚Šæ¨ã¦ï¼‰
        out_h = int(1 + (H - self.pool_h) / self.stride)
        # å‡ºåŠ›ã®å¹…ï¼ˆç«¯æ•°åˆ‡ã‚Šæ¨ã¦ï¼‰
        out_w = int(1 + (W - self.pool_w) / self.stride)

        # å…¥åŠ›xã‚’ï¼’æ¬¡å…ƒé…åˆ—colã«å¤‰æ›ã™ã‚‹
        col = im2col(x, self.pool_h, self.pool_w, self.stride, self.pad)

        # ãƒãƒ£ãƒ³ãƒãƒ«æ–¹å‘ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¨ªã«ä¸¦ã‚“ã§ã„ã‚‹ã®ã§ã€ç¸¦ã«ä¸¦ã¹æ›¿ãˆã‚‹
        col = col.reshape(-1, self.pool_h*self.pool_w)

        # æœ€å¤§å€¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ±‚ã‚ã‚‹ï¼ˆé€†ä¼æ’­æ™‚ã«ä½¿ç”¨ã™ã‚‹ï¼‰
        arg_max = np.argmax(col, axis=1)

        # æœ€å¤§å€¤ã‚’æ±‚ã‚ã‚‹
        out = np.max(col, axis=1)

        # ç”»åƒå½¢å¼ã«æˆ»ã—ã¦ã€ãƒãƒ£ãƒ³ãƒãƒ«ã®è»¸ã‚’ï¼’ç•ªç›®ã«ç§»å‹•ã•ã›ã‚‹
        out = out.reshape(N, out_h, out_w, C).transpose(0, 3, 1, 2)

        self.x = x
        self.arg_max = arg_max

        return out

    def backward(self, dout):
        dout = dout.transpose(0, 2, 3, 1)

        pool_size = self.pool_h * self.pool_w
        dmax = np.zeros((dout.size, pool_size))
        dmax[np.arange(self.arg_max.size), self.arg_max.flatten()] = dout.flatten()
        dmax = dmax.reshape(dout.shape + (pool_size,))

        dcol = dmax.reshape(dmax.shape[0] * dmax.shape[1] * dmax.shape[2], -1)
        dx = col2im(dcol, self.x.shape, self.pool_h, self.pool_w, self.stride, self.pad)

        return dx
```

:::

# ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰

- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã™ã‚‹ä½ç½®ã®é–“éš”ã‚’ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼ˆstrideï¼‰ã¨ã„ã†ã€‚
- ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’ï¼’ã«ã™ã‚‹ã¨ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã™ã‚‹çª“ã®é–“éš”ãŒï¼’è¦ç´ ã”ã¨ã«ãªã‚‹ã€‚

# ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°

- ç•³ã¿è¾¼ã¿å±¤ã®å‡¦ç†ã‚’è¡Œã†å‰ã«ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å‘¨å›²ã«å›ºå®šã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãŸã¨ãˆã°ï¼ãªã©ï¼‰ã‚’åŸ‹ã‚ã‚‹ã“ã¨ã€‚

# ç•³ã¿è¾¼ã¿å±¤ã®å‡ºåŠ›ç”»åƒã‚µã‚¤ã‚ºã®è¨ˆç®—

- å…¥åŠ›ã‚µã‚¤ã‚ºã®é«˜ã•ï¼š$H$
- å…¥åŠ›ã‚µã‚¤ã‚ºã®å¹…ï¼š$W$
- ãƒ•ã‚£ãƒ«ã‚¿ã®é«˜ã•ï¼š$FH$
- ãƒ•ã‚£ãƒ«ã‚¿ã®å¹…ï¼š$FW$
- ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼š$P$
- ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼š$S$

- å‡ºåŠ›ç”»åƒã®é«˜ã•ï¼š

$$
  \frac{H + 2 \times P - FH}{S} + 1
$$

- å‡ºåŠ›ç”»åƒã®å¹…ï¼š

$$
  \frac{W + 2 \times P - FW}{S} + 1
$$

# è¨ˆç®—é‡

- å…¥åŠ›ãƒãƒƒãƒ—ï¼š$H \times W \times C$
- ã‚«ãƒ¼ãƒãƒ«ï¼š$K \times K \times C$
- å‡ºåŠ›ãƒãƒƒãƒ—ï¼š$H \times W \times M$

ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼‘ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚ã‚Šã®å ´åˆã®ï¼‘ã¤ã®ç‚¹ã§ã®è¨ˆç®—é‡ã¯ã€$K \times K \times C \times M$ \
å‡ºåŠ›ãƒãƒƒãƒ—å…¨ä½“ã™ã‚‹ã¨ã€$H \times W \times K \times K \times C \times M$

# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

| åç§°      | ã‚¯ãƒ©ã‚¹ | Train+Val | BOX/ç”»åƒ |    ç”»åƒã‚µã‚¤ã‚º    | Ground-Truth BB |
| :-------- | :----: | :-------: | :------: | :--------------: | :-------------: |
| VOC12     |   20   |  11,540   |   2.4    | $470 \times 380$ |   å·¦ä¸Šã¨å³ä¸‹    |
| ILSVRC17  |  200   |  476,668  |   1.1    | $500 \times 400$ |                 |
| MS COCO18 |   80   |  123,287  |   7.3    | $640 \times 480$ |                 |
| OICOD18   |  500   | 1,743,042 |   7.0    |    ä¸€æ§˜ã§ãªã„    |                 |

- VOC12ï¼šVisual Object Classes
- ILSVRC17ï¼šImageNet Scale Visual Recognition Challenge
- MS COCO18ï¼šMS Common Object in Context
- OICOD18ï¼šOpen Images Challenge Object Detection

# è©•ä¾¡é–¢æ•°

## IoU

- ãƒœãƒƒã‚¯ã‚¹ã®é‡ãªã‚Šã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã®æŒ‡æ¨™

$$
\begin{aligned}
  IoU &= \frac{TP}{TP+FP+FN}\\[12px]
  &= \frac{Area \hspace{2mm} of \hspace{2mm} Overlap}{Area \hspace{2mm} of \hspace{2mm} Union}
\end{aligned}
$$

## AP

- äºˆæ¸¬ã—ãŸå„ãƒœãƒƒã‚¯ã‚¹ã«ã¤ã„ã¦ True ã¨ False ã‚’åˆ¤å®šã§ãã€é€šå¸¸ã®ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨åŒæ§˜ã«å„ã‚¯ãƒ©ã‚¹ã«ã¤ã„ã¦é©åˆç‡ã‚„å†ç¾ç‡ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

$$
\begin{aligned}
    AP = \int_0^1 P(R)dR
\end{aligned}
$$

## mAP

- AP ã¯å„ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦è¨ˆç®—ã§ãã‚‹ã€‚
- ãƒ¢ãƒ‡ãƒ«å…¨ã¦ã®ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ AP ã‚’ç®—å‡ºã—ã€å¹³å‡ã‚’å–ã£ãŸå€¤

$$
\begin{aligned}
    mAP = \frac{1}{C} \sum_{i=1}^C AP_i
\end{aligned}
$$

# im2col

- ãƒ•ã‚£ãƒ«ã‚¿ã«ã¨ã£ã¦éƒ½åˆã®è‰¯ã„ã‚ˆã†ã«å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã™ã‚‹ã€‚
- å…·ä½“çš„ã«ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã™ã‚‹å ´æ‰€ã®é ˜åŸŸï¼ˆï¼“æ¬¡å…ƒã®ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã‚’æ¨ªæ–¹å‘ã«ï¼‘åˆ—ã«å±•é–‹ã™ã‚‹ã€‚
- ç•³ã¿è¾¼ã¿æ¼”ç®—ã®å®Ÿè£…ã¯ã€for æ–‡ã‚’å¹¾é‡ã«ã‚‚é‡ã­ãŸå®Ÿè£…ã«ãªã‚‹ãŒã€NumPy ã§ã¯ã€for æ–‡ã‚’ä½¿ã†ã¨å‡¦ç†ãŒé…ããªã£ã¦ã—ã¾ã†ã€‚

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹ Deep Learning](https://www.oreilly.co.jp/books/9784873117584/)ã‹ã‚‰å¼•ç”¨

```python:pytyhon
def im2col(input_data, filter_h, filter_w, stride=1, pad=0):
    """
    Parameters
    ----------
    input_data : (ãƒ‡ãƒ¼ã‚¿æ•°, ãƒãƒ£ãƒ³ãƒãƒ«, é«˜ã•, å¹…)ã®4æ¬¡å…ƒé…åˆ—ã‹ã‚‰ãªã‚‹å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
    filter_h : ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é«˜ã•
    filter_w : ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¹…
    stride : ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰
    pad : ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
    Returns
    -------
    col : 2æ¬¡å…ƒé…åˆ—
    """
    N, C, H, W = input_data.shape

    # å‡ºåŠ›ã‚µã‚¤ã‚ºã®è¨ˆç®—
    out_h = (H + 2*pad - filter_h)//stride + 1
    out_w = (W + 2*pad - filter_w)//stride + 1

    # å…¥åŠ›ç”»åƒã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
    img = np.pad(input_data, [(0,0), (0,0), (pad, pad), (pad, pad)], 'constant')

    col = np.zeros((N, C, filter_h, filter_w, out_h, out_w))

    # ãƒ•ã‚£ãƒ«ã‚¿ã«å¯¾ã™ã‚‹ç”»åƒã‚’ã‚¹ãƒ©ã‚¤ã‚¹
    for y in range(filter_h):
        y_max = y + stride*out_h
        for x in range(filter_w):
            x_max = x + stride*out_w
            col[:, :, y, x, :, :] = img[:, :, y:y_max:stride, x:x_max:stride]

    # ï¼ˆç”»åƒæšæ•° * ç•³ã¿è¾¼ã¿å›æ•° * ãƒ•ã‚£ãƒ«ã‚¿ã®è¦ç´ æ•°)ã®è¡Œåˆ—ã«å¤‰æ›
    col = col.transpose(0, 4, 5, 1, 2, 3).reshape(N * out_h * out_w, -1)
    return col
```
