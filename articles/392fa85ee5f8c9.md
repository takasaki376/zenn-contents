---
title: "Django REST Framework"
emoji: "🐈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "django"]
published: false
---

# Django について

- ユーザー認証
- 管理画面
- データベース(O/R マッパー)
- 自動テスト

# 実行環境

- Windows10
- PyCharm(日本語化済)
- Python
- Django
- Django Restframework

# 実現すること

- todo リストの機能を REST API で実現する。
- Django 標準のユーザ認証機能を使用する。（標準機能なので認可まで）
- todo のデータにアクセス可能なのはログインしている本人のみとする。
- クラウドなど公開する事を考慮して、一部環境変数に持たせる。

# 仮想環境作成

# エディタの設定

## PyCharm の場合

## VScode の場合

# パッケージインストール

```shell
> pip install Django
> pip install djangorestframework
> pip install django-cors-headers
> pip install djoser
> pip install djangorestframework-simplejwt
> pip install django-environ
> pip install dj-database-url
```

# プロジェクト作成

設定ファイル(setting.py)など、自動的に作成されます。

```shell
> django-admin startproject [プロジェクト名]
```

```shell
> django-admin startproject task
```

# アプリケーション作成

```shell
> django-admin startapp [アプリ名]
```

```shell
> django-admin startapp api
```

# ローカルサーバ起動設定(PyCharm の場合)

manage.py を右クリック →「実行」をクリックする。

http://127.0.0.1:8000/ にアクセスして Django のデフォルト画面が起動する事を確認する。

# setting.py の編集

```diff py
from pathlib import Path
import os
+ import environ
+ from datetime import timedelta

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

+ env = environ.Env()
+ env.read_env(os.path.join(BASE_DIR, '.env'))
```

SECRET_KEY は github で公開しないように環境変数に持たせた値を設定するようにします。
設定する文字はランダムな文字列として下さい。

```diff py
# SECURITY WARNING: keep the secret key used in production secret!
-SECRET_KEY = 'rz-k-y6g^%pr$0og+j%8wqd3%c_@4a8_-*xgmgz%29m!f9o2k_'
+SECRET_KEY=env('SECRET_KEY')
```

開発時と本番環境で設定値を変更したいので、環境変数に持たせます。
開発環境：Treu、本番環境：False

```diff py
# SECURITY WARNING: don't run with debug turned on in production!
- DEBUG = True
+ DEBUG = env('DEBUG')
```

開発時と本番環境で設定値を変更したいので、環境変数に持たせます。
ローカル環境：127.0.0.1、本番環境：ドメイン

```diff py
- ALLOWED_HOSTS = []
+ ALLOWED_HOSTS = env.list('ALLOWED_HOST')
```

```diff py
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
+   'rest_framework',            # djangorestframeworkを使用するための記述です
+   'api.apps.ApiConfig',        # 記載方法は後述します。
+   'corsheaders',               # django-cors-headersを使用するための記述です
+   'djoser',                    # djoserを使用するための記述です
]
MIDDLEWARE = [
+   'corsheaders.middleware.CorsMiddleware',  # django-cors-headersを使用するための記述です
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'django_structlog.middlewares.RequestMiddleware',
]
```

フロントエンド側の URL を記述します。
例：http://localhost:3000
開発時と本番環境で設定値を変更したいので、環境変数に持たせます。

```diff py
+CORS_ORIGIN_WHITELIST = env.list('CORS_ORIGIN_WHITELIST')
```

DEFAULT_PERMISSION_CLASSES はアクセス許可のデフォルト値を設定します。
djangorestframework にて使用されます。[公式ページ](https://www.django-rest-framework.org/api-guide/permissions/#setting-the-permission-policy)
下記の設定を記述する事で、ログイン中のみアクセス可能になります。
※今回の例は、ログインしているユーザ自身のデータのみアクセス可能に
　する対応を行うため、DEFAULT_PERMISSION_CLASSES の設定をしなくても
　影響ありません。

DEFAULT_AUTHENTICATION_CLASSES は認証スキームのデフォルト値を設定します。
[公式ページ](https://www.django-rest-framework.org/api-guide/authentication/#setting-the-authentication-scheme)
下記の設定をする事で、認証に djangorestframework-simplejwt を使用する設定となります。
[公式ページ](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/experimental_features.html)

```diff py
+REST_FRAMEWORK = {
+   'DEFAULT_PERMISSION_CLASSES': [
+        'rest_framework.permissions.IsAuthenticated',
+    ],
+    'DEFAULT_AUTHENTICATION_CLASSES': [
+        'rest_framework_simplejwt.authentication.JWTAuthentication',
+    ],
+}
```

トークンの持続時間の設定

```diff py
+SIMPLE_JWT = {
+    'AUTH_HEADER_TYPES':('JWT',),
+    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=1200)
+}
```

# テーブル定義からマイグレーション実行まで

## api/models.py の編集

## api/admin.py の編集

Django administration に表示されます。
Django administration に表示させたくない場合は不要です。

## マイグレーション

```shell
> python manage.py makemigrations
> python manage.py migrate
```

## スーパーユーザ作成

```
> python manage.py createsuperuser
Username (leave blank to use 'os loginuser'): [ユーザ名を入力する]
Email address: [空白のままEnterキー]
Password: [パスワードを入力する]
Password (Username): [再度パスワードを入力する]
The password is too similar to the username.   # パスワードが簡単な場合に表示される
This password is too short. It must contain at least 8 characters.  # パスワードが簡単な場合に表示される
This password is too common.
Bypass password validation and create user anyway? [y/N]: y   # パスワードが簡単な場合の確認メッセージ
Superuser created successfully.
```

## ローカルサーバ起動

# アプリケーションの開発

## api/serializers.py 新規作成

## api/views.py の編集

## task/urls.py の編集

## api/urls.py の編集

# 動作確認

- http://127.0.0.1:8000/api/task/
  - GET メソッド：リスト表示されること
  - POST メソッド：新規登録されること
- http://127.0.0.1:8000/api/task/[pk]/
  ※pk は各データの id の値
  - GET メソッド：該当データが１件表示されること
  - PUT メソッド；更新されること
  - PATCH メソッド：指定した項目のみ更新されること
  - DELETE メソッド：削除されること
- http://127.0.0.1:8000/api/tasklist/
  - GET メソッド：リスト表示されること

## djangorestframework の画面から確認

## postman を使用して確認
