---
title: "Oracle 19cをMiracle Linuxにインストールする"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["oracle", "linux"]
published: false
---

# 概要

Windows10 Pro 端末のローカルに仮想環境（Miracle Linix 8.4）を作成し、Oracle 19C をインストールします。

# OracleDtabase19c のダウンロード

[Oracle 公式ページ](https://www.oracle.com/jp/database/technologies/oracle-database-software-downloads.html)からダウンロードする。

![ダウンロード](https://storage.googleapis.com/zenn-user-upload/782ecc61421f0e9fac023175.jpg)

ダウンロードしたファイルは、後ほど Linux 環境へ FTP などで仮想マシンへ格納して下さい。
格納場所は`/u01/app/oracle/product/19.3.0/dbhome_1`になります。

# 環境設定

以下の設定変更は root ユーザで実行して下さい。

## THP の設定

`GRUB_CMDLINE_LINUX`の設定値に`transparent_hugepage=never` の設定を grub に追加する

```shell:bash
[root@dlp ~]# vi /etc/default/grub
```

※vi エディタを使用していますが、vi の操作方法については説明を省略します。

```diff:/etc/default/grub
- GRUB_CMDLINE_LINUX="crashkernel=auto resume=/dev/mapper/ml-swap rd.lvm.lv=ml/root rd.lvm.lv=ml/swap rhgb quiet"
+ GRUB_CMDLINE_LINUX="crashkernel=auto resume=/dev/mapper/ml-swap rd.lvm.lv=ml/root rd.lvm.lv=ml/swap rhgb quiet transparent_hugepage=never"
```

設定の有効化

```shell:bash
[root@dlp ~]# grub2-mkconfig -o /boot/grub2/grub.cfg
    Generating grub configuration file ...
    Adding boot menu entry for EFI firmware configuration
    done
```

再起動する。

```shell:bash
[root@dlp ~]# reboot
```

## パッケージインストール

```shell:bash
[root@dlp ~]# dnf -y install bc binutils elfutils-libelf elfutils-libelf-devel fontconfig-devel glibc glibc-devel ksh libaio libaio-devel libgcc libgcc.i686 libstdc++ libstdc++-devel libXi libXtst libnsl make sysstat gcc gcc-c++ libXrender libXrender-devel libX11 libXau libxcb smartmontools java-1.8.0-openjdk
```

## カーネル設定

```shell:bash
# カーネルパラメータの設定用の変数定義
[root@dlp ~]# MEMTOTAL=$(free -b | sed -n '2p' | awk '{print $2}')
[root@dlp ~]# SHMMAX=$(expr $MEMTOTAL / 2)
[root@dlp ~]# SHMMNI=4096
[root@dlp ~]# PAGESIZE=$(getconf PAGE_SIZE)
# カーネルパラメータの設定
# catから最後のEOFまつまでまとめてコピーして貼り付け
  cat > /etc/sysctl.d/50-oracle.conf << EOF
fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmax = $SHMMAX
kernel.shmall = $(expr \( $SHMMAX / $PAGESIZE \) \* \( $SHMMNI / 16 \))
kernel.shmmni = $SHMMNI
kernel.sem = 250 32000 100 128
kernel.panic_on_oops = 1
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
EOF
# カーネルパラメータ読み込み
  sysctl -p /etc/sysctl.d/50-oracle.conf
```

## グループ作成

```shell:bash
#　DB用グループ作成
[root@dlp ~]# groupadd -g 54321 oinstall
[root@dlp ~]# groupadd -g 54322 dba
[root@dlp ~]# groupadd -g 54323 oper
[root@dlp ~]# groupadd -g 54324 backupdba
[root@dlp ~]# groupadd -g 54325 dgdba
[root@dlp ~]# groupadd -g 54326 kmdba
[root@dlp ~]# groupadd -g 54327 asmdba
[root@dlp ~]# groupadd -g 54328 asmoper
[root@dlp ~]# groupadd -g 54329 asmadmin
[root@dlp ~]# groupadd -g 54330 racdba

# グループ確認
  cat /etc/group
  (省略)
  oinstall:x:54321:
  dba:x:54322:
  oper:x:54323:
  backupdba:x:54324:
  dgdba:x:54325:
  kmdba:x:54326:
  asmdba:x:54327:
  asmoper:x:54328:
  asmadmin:x:54329:
  racdba:x:54330:
```

## ユーザ作成

oracle ユーザを作成する。

```shell:bash
[root@dlp ~]# useradd -u 54321 -g oinstall -G dba,oper,backupdba,dgdba,kmdba,asmdba,racdba -d /usr/oracle oracle
[root@dlp ~]# passwd oracle
```

oracle ユーザで sudo を実行可能にする。

```shell:bash
[root@dlp ~]# visudo
```

最終行に追加する

```diff:visudo
+ oracle ALL=(ALL) ALL
```

## 環境設定

```shell:bash
[root@dlp ~]# vi /etc/security/limits.d/50-oracle.conf
```

```diff:50-oracle.conf
oracle soft nofile 1024
oracle hard nofile 65536
oracle soft nproc 16384
oracle hard nproc 16384
oracle soft stack 10240
oracle hard stack 32768
oracle hard memlock 134217728
oracle soft memlock 134217728
```

## ディレクトリ作成

```shell:bash
[root@dlp ~]# mkdir -p /u01/app/oracle/product/19.3.0/dbhome_1
[root@dlp ~]# chown -R oracle:oinstall /u01/app
[root@dlp ~]# chmod -R 755 /u01
```

※ダウンロードした`LINUX.X64_193000_db_home.zip`を`/u01/app/oracle/product/19.3.0/dbhome_1`に格納して下さい。

# Oracle インストール

oracle ユーザでログインして下さい。

## 環境変数の設定

SID、キャラクタ・セットは今回は Unicode で進めますが任意の設定に変更して下さい。

```shell:bash
[oracle@dlp ~]$ vi ~/.bash_profile
```

```diff:.bash_profile
umask 022
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1
export PATH=$PATH:$ORACLE_HOME/bin
export ORACLE_SID=orcl
export NLS_LANG=Japanese_Japan.AL32UTF8
export PATH=$ORACLE_HOME/bin:$PATH
export LANG=ja_JP.UTF-8
export CV_ASSUME_DISTID=RHEL8.2
```

環境変数を反映します。

```shell:bash
[oracle@dlp ~]#
  source /home/oracle/.bash_profile
```

## インストーラー解凍

```shell:bash
  cd /u01/app/oracle/product/19.3.0/dbhome_1
  ls -l
    -rw-rw-r--. 1 tsuser tsuser 3059705302 10月 31 12:49 LINUX.X64_193000_db_home.zip
  unzip LINUX.X64_193000_db_home.zip
```

## JRE の日本語化対応

oracle のインストーラーに付属の JRE は日本語に対応していないため、最初にインストールした jre（jdk の中にある）と入れ替える。

※下記のフォルダ名にある`java-1.8.0-openjdk-1.8.0.312.b07-1.el8.x86_64`の部分は、インストール時のバージョンによって変わるため、フォルダ名を確認して下さい。

```shell:bash
[oracle@dlp ~]$ mv /u01/app/oracle/product/19.3.0/dbhome_1/jdk/jre /u01/app/oracle/product/19.3.0/dbhome_1/jdk/jre_org
[oracle@dlp ~]$  readlink -e /usr/bin/java /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.312.b07-1.el8.x86_64/jre
[oracle@dlp ~]$  cp -r /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.312.b07-1.el8.x86_64/jre /u01/app/oracle/product/19.3.0/dbhome_1/jdk/jre
[oracle@dlp ~]$  ll /u01/app/oracle/product/19.3.0/dbhome_1/jdk
    合計 5384
      -rwxr-xr-x. 1 oracle oinstall    3244  4月 17  2019 COPYRIGHT
      -rwxr-xr-x. 1 oracle oinstall      40  4月 17  2019 LICENSE
      -rwxr-xr-x. 1 oracle oinstall     159  4月 17  2019 README.html
      -rwxr-xr-x. 1 oracle oinstall  108109  4月 17  2019 THIRDPARTYLICENSEREADME-JAVAFX.txt
      -rwxr-xr-x. 1 oracle oinstall  155002  4月 17  2019 THIRDPARTYLICENSEREADME.txt
      drwxr-xr-x. 2 oracle oinstall    4096  4月 18  2019 bin
      drwxr-xr-x. 3 oracle oinstall    4096  4月 17  2019 include
      -rwxr-xr-x. 1 oracle oinstall 5207434  4月 17  2019 javafx-src.zip
      drwxr-xr-x. 4 oracle oinstall    4096 11月  3 16:17 jre
      drwxr-xr-x. 5 oracle oinstall    4096  4月 18  2019 jre_org
      drwxr-xr-x. 5 oracle oinstall    4096  4月 17  2019 lib
      -rwxr-xr-x. 1 oracle oinstall     424  4月 17  2019 release
```

`jre`フォルダが表示されること（`drwxr-xr-x. 4 oracle oinstall 4096 11月 3 16:17 jre`の行）

## インストール開始

コンソールに oracle ユーザでログインし、下記のコマンドをターミナルから実行して下さい。
インストール用の画面が起動します。

```shell:bash
[oracle@dlp ~]$ cd /u01/app/oracle/product/19.3.0/dbhome_1
[oracle@dlp ~]$ ./runInstaller
```

インストール画面が起動します。`次へ`をクリックして下さい。

![インストール](https://storage.googleapis.com/zenn-user-upload/4cd537c51966f2d73177a688.jpg)

`サーバー・クラス`を選択して、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/ed2280048ab81f5671fe7d6d.jpg)

データベースのエディションは任意のエディションを選択し、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/4a29921ebedda5f9b5bf4aa1.jpg)

インストール先のディレクトリは変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/c805e3833a51fb77de010b6b.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/2df6523bee9c6621b316c785.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/14139899518a2d658e11d6d6.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/03c094caa19c89b9c40e052d.jpg)

メモリの割り当て量は任意の値に変更して下さい。
キャラクタ・セットは今回は Unicode で進めますが任意の設定に変更して下さい。
`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/647ff2875bd41bd4486446ec.jpg)
![インストール](https://storage.googleapis.com/zenn-user-upload/09cb36f9eebffea18cc07adc.jpg)
![インストール](https://storage.googleapis.com/zenn-user-upload/4fae92d7a89bbd49e68b67b9.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/ef920b0f7a5bdd490c00ef3c.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/1be56d257c3dbfbd71f8420e.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/c2d1faac6968e97b7de3f1b4.jpg)

`すべてのアカウントに同じパスワードを使用`を選択し、パスワードを入力後に`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/5883ceda1dcf7fb1fb3267d9.jpg)

何も変更せずに、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/c6775902c3786ca4cb77e72c.jpg)

`構成スクリプトを自動的に実行`をチェックし、`rootユーザーの資格証明を使用`がチェックされていることを確認し、root ユーザのパスワードを入力して下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/7c73652b88747afa88c29561.jpg)

`すべて無視`をチェックし、`次へ`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/7fd42d63b55a712b9144e8f7.jpg)

確認メッセージが表示されるので、`はい`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/8458a42acfdf748d4c671143.jpg)

`インストール`をクリックして下さい。
![インストール](https://storage.googleapis.com/zenn-user-upload/fb0873bca76b6840d86534dd.jpg)

途中で、`ファイル%fileName%が見つかりません`と表示されたら、`続行`を押します。

![インストール](https://storage.googleapis.com/zenn-user-upload/602714ed41e3b0b8e0efc6cf.jpg)

構成スクリプトの実行の確認が出たら、`はい`を押します。

![インストール](https://storage.googleapis.com/zenn-user-upload/c2aba17ee7e85a2a376e9ad6.jpg)

この画面が表示されるとインストール完了です。`閉じる`をクリックして下さい。

![インストール](https://storage.googleapis.com/zenn-user-upload/ad62ef867cfa2df7e6935de4.jpg)

## サービス作成

### dbstart および dbshut の許可設定

```shell:bash
[oracle@dlp ~]$ vi /etc/oratab
```

```diff:oratab
- orcl:/u01/app/oracle/product/19.3.0/dbhome_1:N
+ orcl:/u01/app/oracle/product/19.3.0/dbhome_1:Y
```

### サービス用の環境変数設定(ファイルの新規作成)

```shell:bash
[oracle@dlp ~]$ vi /etc/sysconfig/oracle.oracledb
```

```diff:oracle.oracledb
ORACLE_BASE=/u01/app/oracle
ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1
ORACLE_SID=orcl
```

### リスナー用のサービス作成

```shell:bash
[root@dlp ~]# vi /usr/lib/systemd/system/oracle@lsnrctl.service
```

```diff:oracle@lsnrctl.service
[Unit]
Description=Oracle Net Listener
After=network.targe

[Service]
Type=forking
EnvironmentFile=/etc/sysconfig/oracle.oracledb
ExecStart=/u01/app/oracle/product/19.3.0/dbhome_1/bin/lsnrctl start
ExecStop=/u01/app/oracle/product/19.3.0/dbhome_1/bin/lsnrctl stop
User=oracle

[Install]
WantedBy=multi-user.target
```

### Oracle Database19c のサービス作成

```shell:bash
[root@dlp ~]# vi /usr/lib/systemd/system/oracle@oracledb.service
```

```diff:oracle@oracledb.service
[Unit]
Description=Oracle Database service
After=network.target lsnrctl.service

[Service]
Type=forking
EnvironmentFile=/etc/sysconfig/oracle.oracledb
ExecStart=/u01/app/oracle/product/19.3.0/dbhome_1/bin/dbstart $ORACLE_HOME
ExecStop=/u01/app/oracle/product/19.3.0/dbhome_1/bin/dbshut $ORACLE_HOME
User=oracle

[Install]
WantedBy=multi-user.target
```

### サービスの登録・起動

```shell:bash
[root@dlp ~]# systemctl daemon-reload
[root@dlp ~]# systemctl enable --now oracle@lsnrctl oracle@oracledb
Created symlink /etc/systemd/system/multi-user.target.wants/oracle@lsnrctl.service → /usr/lib/systemd/system/oracle@lsnrctl.service.
Created symlink /etc/systemd/system/multi-user.target.wants/oracle@oracledb.service → /usr/lib/systemd/system/oracle@oracledb.service.
Job for oracle@lsnrctl.service failed because the control process exited with error code.
See "systemctl status oracle@lsnrctl.service" and "journalctl -xe" for details.
```

# 起動確認

⇒ サービス起動していない

```shell:bash
[oracle@dlp ~]$ systemctl status oracle@lsnrctl
oracle@lsnrctl.service - Oracle Net Listener
   Loaded: loaded (/usr/lib/systemd/system/oracle@lsnrctl.service; enabled; vendor preset: disabled)
   Active: failed (Result: exit-code) since Sun 2021-12-05 20:56:03 JST; 11min ago
  Process: 9160 ExecStart=/u01/app/oracle/product/19.3.0/dbhome_1/bin/lsnrctl start (code=exited, status=1/FAILURE)

12月 05 20:56:03 dbsv lsnrctl[9160]: Log messages written to /u01/app/oracle/diag/tnslsnr/dbsv/listener/alert/log.xml
12月 05 20:56:03 dbsv lsnrctl[9160]: Error listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=dbsv.mshome.net)(POR>
12月 05 20:56:03 dbsv lsnrctl[9160]: TNS-12545: Connect failed because target host or object does not exist
12月 05 20:56:03 dbsv lsnrctl[9160]:  TNS-12560: TNS:protocol adapter error
12月 05 20:56:03 dbsv lsnrctl[9160]:   TNS-00515: Connect failed because target host or object does not exist
12月 05 20:56:03 dbsv lsnrctl[9160]:    Linux Error: 11: Resource temporarily unavailable
12月 05 20:56:03 dbsv lsnrctl[9160]: Listener failed to start. See the error message(s) above...
12月 05 20:56:03 dbsv systemd[1]: oracle@lsnrctl.service: Control process exited, code=exited status=1
12月 05 20:56:03 dbsv systemd[1]: oracle@lsnrctl.service: Failed with result 'exit-code'.
12月 05 20:56:03 dbsv systemd[1]: Failed to start Oracle Net Listener.
```

```shell:bash
[oracle@dlp ~]$ systemctl status oracle@oracledb
oracle@oracledb.service - Oracle Database service
   Loaded: loaded (/usr/lib/systemd/system/oracle@oracledb.service; enabled; vendor preset: disabled)
   Active: failed (Result: timeout) since Sun 2021-12-05 20:56:23 JST; 11min ago
  Process: 9159 ExecStart=/u01/app/oracle/product/19.3.0/dbhome_1/bin/dbstart $ORACLE_HOME (code=killed, signal=TERM)

12月 05 20:54:52 dbsv systemd[1]: Starting Oracle Database service...
12月 05 20:55:23 dbsv dbstart[9159]: Processing Database instance "orcl": log file /u01/app/oracle/product/19.3.0/dbhom>
12月 05 20:56:23 dbsv systemd[1]: oracle@oracledb.service: start operation timed out. Terminating.
12月 05 20:56:23 dbsv systemd[1]: oracle@oracledb.service: Failed with result 'timeout'.
12月 05 20:56:23 dbsv systemd[1]: Failed to start Oracle Database service.
```

## 1521 ポート確認

```shell:bash
[oracle@dlp ~]$ ss -napt | grep 1521
```

# 参考ページ

- [Oracle Dtabase 19c（CentOS8）](https://daredemose.com/linux/oracle-dtabase-19c/)
- [[ Linux ] CentOS7 grub の編集 (transparent hugepage 無効化設定編)](https://qiita.com/penguin_dream/items/2455a36a634567f4d86b)
- [CentOS 8 : Oracle Database 19c : インストール](https://www.server-world.info/query?os=CentOS_8&p=oracle19c&f=2)
- [Hyper-V on Windows10 環境で任意の固定 IP アドレスを割り当てる方法](https://chiritsumo-life.com/20200718/hyperv-closednetwork/)
